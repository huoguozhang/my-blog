# å‰è¨€:
#### é¢„è§ˆï¼š
**âš ï¸æ³¨æ„**: è…¾è®¯äº‘åˆ°æœŸäº†ä¸èƒ½é¢„è§ˆäº†ğŸ˜³ï¼Œä¸‹æ–‡æåŠåˆ°è…¾è®¯äº‘çš„é“¾æ¥éƒ½ä¸å¯ç”¨äº†
-  **æœ¬ç«™é¢„è§ˆ:** [è…¾è®¯äº‘ip](http://118.24.115.89)ã€åŸŸå[zhanglijian.top](http://zhanglijian.top)
-  **github**:[https://github.com/huoguozhang/my-blog](https://github.com/huoguozhang/my-blog)

#### å¼€å§‹ï¼š
1. npm i
2. æŠŠmysqlé…ç½®å¥½
3. npm run server or npm run dev

#### å®ç°åŠŸèƒ½ï¼š
-  ç”¨æˆ·: ç™»å½•ã€æ³¨å†Œã€ç”¨æˆ·èµ„æ–™ä¿®æ”¹ï¼Œè¯¦æƒ…é¡µé¢ï¼Œç±»ä¼¼äºç®€ä¹¦çš„æ–‡ç« æ•°é‡ã€æ€»å­—æ•°ã€æ”¶è·çš„å–œæ¬¢æ€»æ•°ï¼Œæ–‡ç« åˆ é™¤ã€‚

![ç”¨æˆ·é¡µé¢.jpg](https://upload-images.jianshu.io/upload_images/6036420-e48a23b57b3b4692?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
-  æ–‡ç« ï¼šæ–‡ç« è¯¦æƒ…é¡µé¢ï¼ŒæŸ¥çœ‹ï¼Œè¯„è®ºï¼Œç‚¹èµå’Œè¸©ï¼Œæ–‡ç« é˜…è¯»æ¬¡æ•°ç»Ÿè®¡

![æ–‡ç« è¯¦æƒ….jpg](https://upload-images.jianshu.io/upload_images/6036420-15f16a93f8ff14ca?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
-  æ–‡ç« ï¼š æ‰€æœ‰æ–‡ç« ï¼Œæ”¯æŒåˆ†é¡µå’ŒæŒ‰å…³é”®è¯ã€æ—¶é—´æŸ¥æ‰¾
![æ‰€æœ‰æ–‡ç« .jpg](https://upload-images.jianshu.io/upload_images/6036420-364e463a81b62ff2?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
-  æ–‡ç« ä¹¦å†™ï¼šæ”¯æŒmarkdownå’Œå›¾ç‰‡æ‹–æ‹½ä¸Šä¼ 

![image](https://upload-images.jianshu.io/upload_images/6036420-75ca7d753e6544db?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
-  é¦–é¡µ:  æ–‡ç« æ¨èï¼Œä½œè€…æ¨èï¼Œé¦–é¡µè½®æ’­ï¼Œé¡¶éƒ¨æœç´¢æ–‡ç« å’Œç”¨æˆ·
![é¦–é¡µ.jpg](https://upload-images.jianshu.io/upload_images/6036420-8ff57f2d6da1da16?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

-  ssr  æ•ˆæœé¢„è§ˆï¼š
ç±»ä¼¼äºçŸ¥ä¹çš„
![ssr.jpg](https://upload-images.jianshu.io/upload_images/6036420-36e48e517c74edd8?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- seo æ•ˆæœï¼š
å¾…è¡¥å……

# 1 æŠ€æœ¯æ ˆï¼š
-   å‰ç«¯ï¼šaxiosã€element-uiã€nuxt.jsã€ ts
-   åç«¯ï¼šnode.jsã€hapi.jsã€sequelize(orm)ã€ hapi-auth(token)ã€ hapi-swagger(åœ¨çº¿apiæ–‡æ¡£)ã€hapi-pagination(åˆ†é¡µ)ã€joi(å‰ç«¯è¯·æ±‚æ•°æ®æ£€éªŒç±»ä¼¼äºelementçš„è¡¨å•æ ¡éªŒ)ã€ mysql å’Œå…¶ä»–æ’ä»¶ 

#  2 æŠ€æœ¯ç»†èŠ‚ä»‹ç»ï¼š
**è¯´æ˜:** æœ¬æ–‡ä¸»è¦ä¾§é‡åç«¯ï¼Œæœ€åçš„æ•ˆæœç±»ä¼¼äºæˆ‘å¸åç«¯
#### ç›®å½•ç»“æ„ï¼š
```
â”œâ”€â”€ assets // é™æ€èµ„æºï¼Œcss, å›¾ç‰‡ç­‰
â”œâ”€â”€ client // å®¢æˆ·ç«¯ç›®å½•ï¼Œaxiosè¯·æ±‚å‡½æ•°å’Œå…¶ä»–è¾…åŠ©å‡½æ•°
â”œâ”€â”€ components // vueç»„ä»¶ç›®å½•
â”œâ”€â”€ config // é»˜è®¤è®¾ç½®
â”œâ”€â”€ layouts // nuxtè§†å›¾
â”œâ”€â”€ middleware // nuxt ä¸­é—´ä»¶
â”œâ”€â”€ migrations // orm æ•°æ®è¿ç§»
â”œâ”€â”€ models // orm æ•°æ®æ¨¡å‹ 
â”œâ”€â”€ nuxt.config.js 
â”œâ”€â”€ nuxt.config.ts
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pages // nuxt
â”œâ”€â”€ plugins // hapiæ’ä»¶å’Œnuxtæ’ä»¶
â”œâ”€â”€ routes // hapiè·¯ç”±
â”œâ”€â”€ seeders // ç§å­æ•°æ®
â”œâ”€â”€ server // app.js
â”œâ”€â”€ static // é™æ€èµ„æº
â”œâ”€â”€ store // nuxt
â”œâ”€â”€ tsconfig.json 
â”œâ”€â”€ uploads // æ–‡ä»¶ä¸Šä¼ ç›®æ ‡ç›®å½•
â””â”€â”€ utils // è¾…åŠ©å‡½æ•°

```
#### å‰è¨€:ä¸ºä»€ä¹ˆæ˜¯hapi.js ?
hapi[å®˜æ–¹æ–‡æ¡£](https://hapi.dev/tutorials/?lang=en_US)å·²ç»è¯´äº†å¾ˆå¤šäº†([expresstohapi](https://hapi.dev/tutorials/expresstohapi/?lang=zh_CN)),è¿™é‡Œæœ€å¸å¼•æˆ‘çš„æ˜¯ï¼Œä¸ç”¨å®‰è£…å¾ˆå¤šçš„æ’ä»¶(expresçš„è¯æœ‰å¾ˆå¤šçš„xx-parseæ’ä»¶...)ï¼Œå°±èƒ½æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼Œè€Œä¸”hapiå·²ç»åº”ç”¨äºå•†ç”¨äº†ã€‚
#### æ³¨æ„ç‚¹:
 æˆ‘çš„è¿™äº›ä»£ç ï¼Œåœ¨æˆ‘ç›®å‰çš„package.jsonçš„ç‰ˆæœ¬æ˜¯èƒ½æ­£å¸¸è¿è¡Œçš„ï¼Œhapiç‰ˆæœ¬å¤§ç‰ˆæœ¬æœ‰æ—¶å€™ä¼šå‡ºç°ä¸å…¼å®¹çš„ï¼Œä¸åŒç‰ˆæœ¬çš„hapiå¯¹åº”ç€ä¸åŒçš„æ’ä»¶ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦å’Œæˆ‘çš„ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæˆ‘è¿˜é‡åˆ°è¿‡nuxt.js v2.9è¿è¡ŒåŠ å…¥tså‡ºç°ä¸è¯†åˆ«@componentçš„æƒ…å†µï¼Œå®‰è£…2.8.xç‰ˆæœ¬å°±æ²¡æœ‰é—®é¢˜ã€‚
## 2.1 Sequelizeå»ºæ¨¡
å¼€å‘åå°ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ˜¯å»ºç«‹æ•°æ®æ¨¡å‹(å»ºè¡¨)ï¼Œé»˜è®¤ä½ å·²ç»å®‰è£…å¥½äº†mysql
ä¹‹å‰æˆ‘è‡ªå·±ç”¨æ•°æ®åº“ï¼Œä¸çŸ¥é“æœ‰ormè¿™ä¸ªå·¥å…·çš„æ—¶å€™ï¼Œä¼šé€‰æ‹©è‡ªå·±ç”¨navicatè¿™æ ·çš„å›¾å½¢åŒ–å·¥å…·å»ºè¡¨æˆ–è€…ç›´æ¥ç”¨sqlè¯­å¥å»ºè¡¨ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªç¼ºç‚¹:
1. å¯¹æ•°æ®åº“çš„æ“ä½œè®°å½•ä¸æ˜ç¡®ï¼Œæˆ‘æ–°å»ºä¸€ä¸ªè¡¨æˆ–è€…æ–°å¢å­—æ®µï¼Œæˆ‘åæ‚”äº†ï¼Œåˆ æ‰ï¼Œæˆ‘åˆåæ‚”äº†ï¼Œormçš„æ•°æ®è¿ç§»å°±å¯ä»¥ç”¨æ¥åšè¿™äº›äº‹æƒ…ç±»ä¼¼äºgitã€‚
2. è¿ç§»æ–°ç¯å¢ƒ,ç”¨sqlæ“ä½œå¾ˆéº»çƒ¦,ç›´æ¥æ‰§è¡Œormçš„å‘½ä»¤è‡ªåŠ¨å»ºè¡¨ã€‚
3. æ•°æ®æ¨¡å‹,ä¹‹å‰åå°ç¨‹åºä¸mysqlè”ç³»çš„æ—¶å€™ï¼Œä»…ä»…åœ¨å»ºç«‹äº†è¿æ¥æ± ï¼Œæ•°æ®çš„å…³ç³»ï¼Œè¡¨ç»“æ„è¿™äº›æˆ‘ä»¬å…¶å®å¹¶ä¸çŸ¥é“ã€‚
4. æ‰§è¡Œå¢åˆ æ”¹æŸ¥ä»£ç æ›´ç®€æ´æ¸…æ™°
5. å…¶ä»–

**æ³¨æ„**ï¼šç”¨ormåœ¨æ‰§è¡Œsqlæ“ä½œæ—¶ï¼Œç›¸å½“äºæˆ‘ä»¬ç”¨jqueryæ‰§è¡Œdomæ“ä½œï¼Œapiç®€å•äº†ï¼Œä½†è¿˜æ˜¯éœ€è¦å¯¹åŸæ¥çš„æœ‰ç‚¹äº†è§£
### sequelize
[sequelize](https://sequelize.org/master/index.html)å°±æ˜¯node.jsçš„promise ormå·¥å…·,åŒæ—¶ä¹Ÿæ”¯æŒå…¶ä»–æ•°æ®åº“.
#### ä½¿ç”¨
1. å®‰è£…æ’ä»¶:
```
npm i sequelize-cli -D
npm i sequelize
npm i mysql2
```
2. sequelize init
é€šè¿‡ sequelize-cli åˆå§‹åŒ– sequelizeï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªå¥½ç”¨çš„åˆå§‹åŒ–ç»“æ„ï¼š
```
// å¯ä»¥å®‰è£…npx
node_modules/.bin/sequelize init
```
```
â”œâ”€â”€ config                       # é¡¹ç›®é…ç½®ç›®å½•
|   â”œâ”€â”€ config.json              # æ•°æ®åº“è¿æ¥çš„é…ç½®
â”œâ”€â”€ models                       # æ•°æ®åº“ model
|   â”œâ”€â”€ index.js                 # æ•°æ®åº“è¿æ¥çš„æ ·æ¿ä»£ç 
â”œâ”€â”€ migrations                   # æ•°æ®è¿ç§»çš„ç›®å½•
â”œâ”€â”€ seeders                      # æ•°æ®å¡«å……çš„ç›®å½•
```
**config/config.json**

é»˜è®¤ç”Ÿæˆæ–‡ä»¶ä¸ºä¸€ä¸ª config.json æ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œé…ç½®äº†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä¸‰ä¸ªé»˜è®¤çš„æ ·æ¿ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰éœ€å†å¢åŠ æ›´å¤šçš„ç¯å¢ƒé…ç½®ã€‚è¿™é‡Œæˆ‘ç”¨config.jsæ›¿ä»£config.jsonï¼Œè¿™æ ·é…ç½®æ›´åŠ çµæ´»
ä¿®æ”¹åçš„ config/config.js å¦‚ä¸‹ï¼Œä»…é¢„ç•™äº† developmentï¼ˆå¼€å‘ï¼‰ ä¸ productionï¼ˆç”Ÿäº§ï¼‰ ä¸¤ä¸ªç¯å¢ƒï¼Œå¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„é…ç½®å‚æ•°å¯ä»¥åˆ†ç¦»åœ¨ .env å’Œ .env.prod ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶é‡Œï¼Œé€šè¿‡ç¯å¢ƒå˜é‡å‚æ•° process.env.NODE_ENV æ¥åŠ¨æ€åŒºåˆ†ã€‚
```
// config.js
if (process.env.NODE_ENV === 'production') {
  require('env2')('./.env.prod')
} else {
  require('env2')('./.env.dev')
}

const { env } = process
module.exports = {
  'development': {
    'username': env.MYSQL_USERNAME,
    'password': env.MYSQL_PASSWORD,
    'database': env.MYSQL_DB_NAME,
    'host': env.MYSQL_HOST,
    'port': env.MYSQL_PORT,
    dialect: 'mysql',
    logging: false, // mysql æ‰§è¡Œæ—¥å¿—
    timezone: '+08:00'
    // "operatorsAliases": false,  // æ­¤å‚æ•°ä¸ºè‡ªè¡Œè¿½åŠ ï¼Œè§£å†³é«˜ç‰ˆæœ¬ sequelize è¿æ¥è­¦å‘Š
  },
  'production': {
    'username': env.MYSQL_USERNAME,
    'password': env.MYSQL_PASSWORD,
    'database': env.MYSQL_DB_NAME,
    'host': env.MYSQL_HOST,
    'port': env.MYSQL_PORT,
    dialect: 'mysql',
    timezone: '+08:00'
    // "operatorsAliases": false, // æ­¤å‚æ•°ä¸ºè‡ªè¡Œè¿½åŠ ï¼Œè§£å†³é«˜ç‰ˆæœ¬ sequelize è¿æ¥è­¦å‘Š
  }
}

```
**.env.dev**
```
# æœåŠ¡çš„å¯åŠ¨åå­—å’Œç«¯å£ï¼Œä½†ä¹Ÿå¯ä»¥ç¼ºçœä¸å¡«å€¼ï¼Œé»˜è®¤å€¼çš„å¡«å†™åªæ˜¯ä¸€å®šç¨‹åº¦å‡å°‘èµ·å§‹æ•°æ®é…ç½®å·¥ä½œ
HOST = 127.0.0.1
PORT = 80
#  ç«¯å£æœ€å¥½å°±ä¸º80ï¼Œä¸ç„¶axios urlè¦æ”¹ä¸ºç»å¯¹åœ°å€
# MySQL æ•°æ®åº“é“¾æ¥é…ç½®
æœ¬é¡¹ç›®éƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼Œå·²ç»å…³é—­äº†3306ç«¯å£
MYSQL_HOST = 111.111.111.111
MYSQL_PORT = 3306
MYSQL_DB_NAME = æ•°æ®åº“å
MYSQL_USERNAME = æ•°æ®åº“ç”¨æˆ·å
MYSQL_PASSWORD = æ•°æ®åº“å¯†ç 
JWT_SECRET = tokenå¯†é’¥

```
3. åˆ›å»ºæ•°æ®åº“
```
npx sequelize db:create
```
4. åˆ›å»ºè¿ç§»æ–‡ä»¶
```
npx migration:create --name user
```
åœ¨ migrations çš„ç›®å½•ä¸­ï¼Œä¼šæ–°å¢å‡ºä¸€ä¸ª æ—¶é—´æˆ³-user.js çš„è¿ç§»æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶é‡Œï¼ŒåŒ…æ¶µæœ‰ up ä¸ down ä¸¤ä¸ªç©ºå‡½æ•°ï¼Œ up ç”¨äºå®šä¹‰è¡¨ç»“æ„æ­£å‘æ”¹å˜çš„ç»†èŠ‚ï¼Œdown åˆ™ç”¨äºå®šä¹‰è¡¨ç»“æ„çš„å›é€€é€»è¾‘ã€‚æ¯”å¦‚ up ä¸­æœ‰ createTable çš„å»ºè¡¨è¡Œä¸ºï¼Œåˆ™ down ä¸­é…å¥—æœ‰ä¸€ä¸ªå¯¹åº”çš„ dropTable åˆ é™¤è¡¨è¡Œä¸ºã€‚ç›¸å½“äºæ˜¯ä¸€æ¡æ“ä½œè®°å½•è®°å½•ã€‚ä¿®æ”¹åçš„ç”¨æˆ·è¿ç§»æ–‡ä»¶å¦‚ä¸‹:
```
'use strict'
module.exports = {
  up: (queryInterface, Sequelize) => queryInterface.createTable(
    'user',
    {
      uid: {
        type: Sequelize.UUID,
        primaryKey: true
      },
      nickname: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true
      },
      avatar: Sequelize.STRING,
      description: Sequelize.STRING,
      username: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true
      },
      password: {
        type: Sequelize.STRING,
        allowNull: false
      },
      created_time: Sequelize.DATE,
      updated_time: Sequelize.DATE
    },
    {
      charset: 'utf8'
    }
  ),

  down: queryInterface => queryInterface.dropTable('user')
}
```

5. æ‰§è¡Œè¿ç§»

```
npx sequelize db:migrate
```
sequelize db:migrate çš„å‘½ä»¤ï¼Œå¯ä»¥æœ€ç»ˆå¸®åŠ©æˆ‘ä»¬å°† migrations ç›®å½•ä¸‹çš„è¿ç§»è¡Œä¸ºå®šä¹‰ï¼ŒæŒ‰æ—¶é—´æˆ³çš„é¡ºåºï¼Œé€ä¸ªåœ°æ‰§è¡Œè¿ç§»æè¿°ï¼Œæœ€ç»ˆå®Œæˆæ•°æ®åº“è¡¨ç»“æ„çš„è‡ªåŠ¨åŒ–åˆ›å»ºã€‚å¹¶ä¸”ï¼Œåœ¨æ•°æ®åº“ä¸­ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªåä¸º SequelizeMeta çš„è¡¨ï¼Œç”¨äºè®°å½•åœ¨å½“å‰æ•°æ®åº“ä¸Šæ‰€è¿è¡Œçš„è¿ç§»å†å²ç‰ˆæœ¬ã€‚å·²ç»æ‰§è¡Œè¿‡çš„ä¸ä¼šå†æ¬¡æ‰§è¡Œï¼Œå¯ä»¥æ‰§è¡Œsequelize db:migrate:undoæ‰§è¡Œä¸Šä¸ªè¿ç§»æ–‡ä»¶çš„downå‘½ä»¤ã€‚

6. ç§å­æ•°æ®

æ‰§è¡Œ
```
sequelize seed:create --name init-user
```
ç±»ä¼¼çš„åœ¨seedersç›®å½•ä¸‹ç”Ÿæˆä¸€ä»½æ–‡ä»¶ æ—¶é—´æˆ³-init-user.js
ä¿®æ”¹å
```
'use strict'
const uuid = require('uuid')
const timeStamp = {
  created_time: new Date(),
  updated_time: new Date()
}
const users = []
for (let i = 1; i < 5; i++) {
  users.push(
    {
      uid: uuid(), username: 'zlj' + i, password: '123', nickname: 'ç«é”…' + 1, ...timeStamp
    }
  )
}
module.exports = {
  up: queryInterface => queryInterface.bulkInsert('user', users, { charset: 'utf-8' }),
  down: (queryInterface, Sequelize) => {
    const { Op } = Sequelize
    return queryInterface.bulkDelete('user', { uid: { [Op.in]: users.map(v => v.uid) } }, {})
  }
}


```
æ‰§è¡Œå¡«å……å‘½ä»¤
```
sequelize db:seed:all
```
æŸ¥çœ‹æ•°æ®åº“userè¡¨å°±å¤šäº†ä¸€äº›è®°å½•ï¼Œå…¶ä»–çš„æ“ä½œç±»ä¼¼äºè¿ç§»ï¼Œæ›´å¤šçš„æ“ä½œå¯ä»¥çœ‹æ–‡æ¡£
7 å®šä¹‰æ¨¡å‹ ï¼ˆæ•°æ®åº“çš„ï¼‰
 userè¡¨ models/user.js
```
const moment = require('moment')
module.exports = (sequelize, DataTypes) => sequelize.define(
  'user',
  {
    uid: {
      type: DataTypes.UUID,
      primaryKey: true
    },
    avatar: DataTypes.STRING,
    description: DataTypes.STRING,
    nickname: {
      type: DataTypes.STRING,
      unique: true,
      allowNull: false
    },
    username: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true
    },
    password: {
      type: DataTypes.STRING,
      allowNull: false
    },
    created_time: {
      type: DataTypes.DATE,
      get () {
        return moment(this.getDataValue('created_time')).format('YYYY-MM-DD HH:mm:ss')
      }
    },
    updated_time: {
      type: DataTypes.DATE,
      get () {
        return moment(this.getDataValue('updated_time')).format('YYYY-MM-DD HH:mm:ss')
      }
    }
  },
  {
    tableName: 'user'
  }
)

```

8. å®ä¾‹åŒ–seqlize
modes/index.js
```
'use strict'
const fs = require('fs')
const path = require('path')
const uuid = require('uuid')
const Sequelize = require('sequelize')
const basename = path.basename(__filename) // eslint-disable-line
const configs = require(path.join(__dirname, '../config/config.js'))
const db = {}
const env = process.env.NODE_ENV || 'development'
const config = {
  ...configs[env],
  define: {
    underscored: true,
    timestamps: true,
    updatedAt: 'updated_time',
    createdAt: 'created_time',
    hooks: {
      beforeCreate (model) {
        model.uid = uuid()
      }
    }
  }
}
let sequelize
if (config.use_env_variable) {
  sequelize = new Sequelize(process.env[config.use_env_variable], config)
} else {
  sequelize = new Sequelize(config.database, config.username, config.password, config)
}
fs
  .readdirSync(__dirname)
  .filter((file) => {
    return (file.indexOf('.') !== 0) && (file !== basename) && (file.slice(-3) === '.js')
  })
  .forEach((file) => {
    const model = sequelize.import(path.join(__dirname, file))
    db[model.name] = model
  })
Object.keys(db).forEach((modelName) => {
  if (db[modelName].associate) {
    db[modelName].associate(db)
  }
})
db.sequelize = sequelize
db.Sequelize = Sequelize
// å¤–é”®å…³è”å…³ç³»
// å‡è®¾ä½ æ‰€æœ‰è¡¨å»ºç«‹å¥½äº†
db.user.hasMany(db.article, { foreignKey: 'uid' })
db.article.belongsTo(db.user, { foreignKey: 'author' })
db.user.hasMany(db.comment, { foreignKey: 'uid' })
db.comment.belongsTo(db.user, { foreignKey: 'author' })
db.user.hasMany(db.article_like, { foreignKey: 'uid' })
db.article_like.belongsTo(db.user, { foreignKey: 'author' })
db.article.hasMany(db.comment)
db.comment.belongsTo(db.article)
db.article.hasMany(db.article_like)
db.article_like.belongsTo(db.article)
module.exports = db
```
9. æœ¬é¡¹ç›®ç”¨åˆ°çš„åŠŸèƒ½

   å¤šè¡¨æŸ¥è¯¢ã€å•è¡¨å¢åˆ æ”¹æŸ¥ã€æ¨¡å‹ç»Ÿä¸€é…ç½®ã€è¿ç§»å’Œç§å­å¡«å……ã€äº‹åŠ¡ï¼ˆåˆ é™¤æ–‡ç« çš„æ—¶å€™ï¼ŒæŠŠæ–‡ç« ç›¸å…³çš„æ•°æ®ï¼šè¯„è®ºï¼Œé˜…è¯»ï¼Œç‚¹èµæ•°æ®ä¹Ÿä¸€èµ·åˆ äº†ã€‚ï¼‰ç­‰ã€‚

## 2.2 Joi è¯·æ±‚å‚æ•°æ ¡éªŒ

joiå¯ä»¥å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œæ ¡éªŒ, å‚æ•°æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå‚æ•°æ˜¯å¦ä¸ºç©ºç­‰ã€‚
#### ä½¿ç”¨ï¼š
1. å®‰è£…
```
# å®‰è£…é€‚é… hapi v16 çš„ joi æ’ä»¶
npm i joi@14
```
2. ä½¿ç”¨è§2.3 config.validateï¼Œæ›´å¤šå‚è€ƒå®˜æ–¹æ–‡æ¡£

## 2.3 ç”¨hapi å†™æ¥å£

**post: ç™»å½•æ¥å£:**
routes/user.js
```
const models = require('../models')
const Joi = require('@hapi/joi')
åœ¨hapiåˆå§‹åŒ–æ—¶ï¼Œæ³¨å†Œè¿™äº›è·¯ç”±
[{
    method: 'POST',
    path: '/api/user/login',
    handler: async (request, h) => {
      const res = await models.user.findAll({
        attributes: {
          exclude: ['password', 'created_time', 'updated_time']
        },
        where: {
          username: request.payload.username,
          // ä¸€èˆ¬å¯†ç å­˜åº“éƒ½ä¼šåŠ å¯†çš„ï¼Œmd5ç­‰
          password: request.payload.password
        }
      })
      const data = res[0]
      if (res.length > 0) {
        return h.response({
          code: 0,
          message: 'ç™»å½•æˆåŠŸ!',
          data: {
            // å†™å…¥token
            token: generateJWT(data.uid),
            ...data.dataValues
          }
        })
      } else {
        return h.response({
          code: 10,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
        })
      }
    },
    config: {
      auth: false,
      tags: ['api', 'user'],
      description: 'ç”¨æˆ·ç™»å½•',
      validate: {
        payload: {
          username: Joi.string().required(),
          password: Joi.string().required()
        }
      }
    }
  }
  ]

```
## 2.4 æ¥å£æ–‡æ¡£swagger

1. å®‰è£…:
```
npm i hapi-swagger@10
npm i inert@5
npm i vision@5
npm i package@1
```
2. ä½¿ç”¨
```
â”œâ”€â”€ plugins                       # hapi æ’ä»¶é…ç½®
|   â”œâ”€â”€ hapi-swagger.js  
```
hapi-swagger.js
```
// plugins/hapi-swagger.js
const inert = require('@hapi/inert')
const vision = require('@hapi/vision')
const package = require('package')
const hapiSwagger = require('hapi-swagger')
module.exports = [
  inert,
  vision,
  {
    plugin: hapiSwagger,
    options: {
      documentationPath: '/docs',
      info: {
        title: 'my-blog æ¥å£ æ–‡æ¡£',
        version: package.version
      },
      // å®šä¹‰æ¥å£ä»¥ tags å±æ€§å®šä¹‰ä¸ºåˆ†ç»„
      grouping: 'tags',
      tags: [
        { name: 'user', description: 'ç”¨æˆ·æ¥å£' },
        { name: 'article', description: 'æ–‡ç« æ¥å£' }
      ]
    }
  }
]
```

 server/index.js
```
const pluginHapiSwagger = require('../plugins/hapi-swagger')
// æ³¨å†Œæ’ä»¶
...
 await server.register([
    // ä¸ºç³»ç»Ÿä½¿ç”¨ hapi-swagger
    ...pluginHapiSwagger
  ]
...
```

 æ‰“å¼€ä½ çš„dev.host:dev.port/docs
 å¯ä»¥æŸ¥çœ‹[æˆ‘çº¿ä¸Šçš„](http://118.24.115.89/docs)

## 2.5 tokenè®¤è¯hapi-auth-jwt2
cookie hapiå·²ç»å¸®ä½ è§£æå¥½äº†ï¼Œæ–‡ä»¶ä¸Šä¼ ä¹Ÿæ˜¯
1. å®‰è£…:
npm i hapi-auth-jwt2@8
2. é…ç½®:
[æ–‡æ¡£](https://www.npmjs.com/package/hapi-auth-jwt2)
```
â”œâ”€â”€ plugins                       # hapi æ’ä»¶é…ç½®
â”‚ â”œâ”€â”€ hapi-auth-jwt2.js           # jwt é…ç½®æ’ä»¶
```
hapi-auth-jwt2.js
```
const validate = (decoded) => {
  // eslint disable
  // decoded ä¸º JWT payload è¢«è§£ç åçš„æ•°æ®
  const { exp } = decoded
  if (new Date(exp * 1000) < new Date()) {
    const response = {
      code: 4,
      message: 'ç™»å½•è¿‡æœŸ',
      data: 'ç™»å½•è¿‡æœŸ'
    }
    return { isValid: true, response }
  }
  return { isValid: true }
}
module.exports = (server) => {
  server.auth.strategy('jwt', 'jwt', {
    // éœ€è¦è‡ªè¡Œåœ¨ config/index.js ä¸­æ·»åŠ  jwtSecret çš„é…ç½®ï¼Œå¹¶ä¸”é€šè¿‡ process.env.JWT_SECRET æ¥è¿›è¡Œ .git ç‰ˆæœ¬åº“å¤–çš„ç®¡ç†ã€‚
    key: process.env.JWT_SECRET,
    validate,
    verifyOptions: {
      ignoreExpiration: true
    }
  })
  server.auth.default('jwt')
}
```

3. æ³¨å†Œæ’ä»¶
server/index.js
```
const hapiAuthJWT2 = require('hapi-auth-jwt2')
...
await server.register(hapiAuthJWT2)
...
```
4. æ•ˆæœ:
é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰çš„æ¥å£éƒ½éœ€è¦tokenè®¤è¯çš„
å¯ä»¥å°†æŸä¸ªæ¥å£(æ¯”å¦‚ç™»å½•æ¥å£)config.auth = falseä¸å¼€å¯
å›åˆ°ä¸Šé¢çš„ç™»å½•æ¥å£,ç”¨æˆ·åå’Œå¯†ç æ£€éªŒæˆåŠŸå°±ç”Ÿæˆtoken
```
const generateJWT = (uid) => {
  const payload = {
    userId: uid,
    exp: Math.floor(new Date().getTime() / 1000) + 24 * 60 * 60
  }
  return JWT.sign(payload, process.env.JWT_SECRET)
}
handler () {
      const res = await models.user.findAll({
        attributes: {
          exclude: ['password', 'created_time', 'updated_time']
        },
        where: {
          username: request.payload.username,
          password: request.payload.password
        }
      })
      const data = res[0]
      if (res.length > 0) {
        return h.response({
          code: 0,
          message: 'ç™»å½•æˆåŠŸ!',
          data: {
            token: generateJWT(data.uid),
            ...data.dataValues
          }
        })
      } else {
        return h.response({
          code: 10,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
        })
      }
    }
```
å‰ç«¯æ‹¿åˆ°tokeå¡åœ¨å¤´éƒ¨å°±å¥½äº†
client/api/index.ts
```
request.interceptors.request.use((config: AxiosRequestConfig): AxiosRequestConfig => {
  const token = getToken()
  if (token) { config.headers.authorization = token }
  return config
})
```
5. è¯·æ±‚å¤´å¢åŠ Joiæ ¡éªŒ
```
const jwtHeaderDefine = {
  headers: Joi.object({
    authorization: Joi.string().required()
  }).unknown()
}
// æŸä¸ªæ¥å£
...
validate: {
        ...jwtHeaderDefine,
        params: {
          uid: Joi.string().required()
        }
      }
...
```
å¯ä»¥ä»swaggeråœ¨çº¿æ–‡æ¡£ä¸­æ–‡çœ‹å‡ºå˜åŒ–

## 2.6 åŠ å…¥åˆ†é¡µhapi-pagination

1. å®‰è£…
npm i hapi-pagination@3
2. é…ç½®
plugins/hapi-pagination.js
```
const hapiPagination = require('hapi-pagination')
const options = {
  query: {
    page: {
      name: 'the_page' // The page parameter will now be called the_page
    },
    limit: {
      name: 'per_page', // The limit will now be called per_page
      default: 10 // The default value will be 10
    }
  },
  meta: {
    location: 'body', // The metadata will be put in the response body
    name: 'metadata', // The meta object will be called metadata
    count: {
      active: true,
      name: 'count'
    },
    pageCount: {
      name: 'totalPages'
    },
    self: {
      active: false // Will not generate the self link
    },
    first: {
      active: false // Will not generate the first link
    },
    last: {
      active: false // Will not generate the last link
    }
  },
  routes: {
    include: ['/article'] // éœ€è¦å¼€å¯çš„è·¯ç”±
  }
}
module.exports = {
  plugin: hapiPagination,
  options
}
```
3. æ³¨å†Œæ’ä»¶
```
const pluginHapiPagination = require('./plugins/hapi-pagination');
await server.register([
  pluginHapiPagination,
])
```
4. åŠ å…¥å‚æ•°æ ¡éªŒ
```
const paginationDefine = {
  limit: Joi.number().integer().min(1).default(10)
    .description('æ¯é¡µçš„æ¡ç›®æ•°'),
  page: Joi.number().integer().min(1).default(1)
    .description('é¡µç æ•°'),
  pagination: Joi.boolean().description('æ˜¯å¦å¼€å¯åˆ†é¡µï¼Œé»˜è®¤ä¸ºtrue')
}
// æŸä¸ªæ¥å£
// joiæ ¡éªŒ
...
validate: {
        query: {
          ...paginationDefine
        }
      }
...
```
5. æ•°æ®åº“æŸ¥è¯¢
```
   const { rows: results, count: totalCount } = await models.xxxx.findAndCountAll({
      limit: request.query.limit,
      offset: (request.query.page - 1) * request.query.limit,
    });
```

# 3 æœ€å
æ¬¢è¿åˆ°çº¿ä¸Šåœ°å€ä½“éªŒå®Œæ•´åŠŸèƒ½
#### 1 è¸©å‘æ€»ç»“:

- ç¢°åˆ°æ¥å£500çš„æƒ…å†µï¼Œå¯ä»¥åœ¨modelçš„æ“ä½œåé¢æ•è·é”™è¯¯,æ¯”å¦‚models.findAll().catch(e => console.log(e))
- æ³¨æ„ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼Œæ’ä»¶å’Œhapiæˆ–è€…nuxtç‰ˆæœ¬çš„å…¼å®¹
- nuxt.config.tsçš„é…ç½®ä¸ç”Ÿæ•ˆå¯ä»¥æ‰§è¡Œtsc nuxt.config.tsæ‰‹åŠ¨ç¼–è¯‘
- åœ¨asyncDataä¸­è¯·æ•°æ®ï¼Œä¸å†™ç»å¯¹åœ°å€ï¼Œä¼šé»˜è®¤è¯·æ±‚80ç«¯å£çš„

#### 2 å¼€å‘æ”¶è·
- ç†Ÿæ‚‰äº†åŸºæœ¬çš„åç«¯å¼€å‘æµç¨‹
- æ’ä»¶ä¸å…¼å®¹æˆ–è€…æœ‰å…¶ä»–éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œå¿…é¡»è‡ªå·±çœ‹è‹±æ–‡æ–‡æ¡£,çœ‹åˆ°è‹±æ–‡æ–‡æ¡£èƒ½æ·¡å®šäº†
- åç«¯å¼€å‘éœ€è¦åšçš„å·¥ä½œè›®å¤šçš„ï¼Œä»æ¥å£åˆ°éƒ¨ç½²ç­‰ï¼Œä»¥åå·¥ä½œä¸­è¦ç›¸äº’ç†è§£

#### 3 å‚è€ƒ
[æ˜é‡‘å°å†Œ: å¶ç››é£ ã€ŠåŸºäº hapi çš„ Node.js å°ç¨‹åºåç«¯å¼€å‘å®è·µæŒ‡å—ã€‹](https://juejin.im/book/5b63fdba6fb9a04fde5ae6d0)

ps:æ¬¢è¿ç‚¹èµstar ^_^
**github**: [https://github.com/huoguozhang/my-blog](https://github.com/huoguozhang/my-blog)
>>>>>>> fef507c01002fa4490966f98248097320647c335
